SET SAFETY OFF 

OPEN VBAK_VBAP_VBKD

delete field Digit_1 Ok
define field Digit_1 computed substr(VBAP_VBELN,1,1)

extract record if Digit_1 = "5" OR Digit_1 = "6" to VBAK_VBAP_VBKD_A OPEN

COMMENT
Considering only 3rd party orders

delete field SOLI OK
define field SOLI computed VBAP_VBELN + VBAP_POSNR

extract record SOLI VBAK_ERNAM VBAP_VBELN VBAP_POSNR VBAK_ERDAT VBAP_ABGRU VBAP_NETWR VBAP_KWMENG VBAP_WERKS VBAP_J_3ARQDA VBAP_ZZCUST_DEPT VBKD_KDGRP to VBAK_VBAP_VBKD_B 

OPEN ZBFH_ZBFD
extract record if ZBFH_LVORM <> "X" to ZBFH_ZBFD_A 

OPEN ZBFINVH 
extract record if ZBFINVH_STATUS <> "9" to ZBFINVH_A

COMMENT
Filtering booking form and finish goods tables

OPEN ZBFH_ZBFD_A PRIMARY 
OPEN ZBFINVH_A SECONDARY 
JOIN PKEY ZBFH_ZINV FIELDS ZBFH_ZBOOKFORM ZBFH_WERKS ZBFH_ZINV ZBFD_VBELN ZBFD_POSNR ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY SKEY ZBFINVH_ZINV WITH ZBFINVH_STATUS PRIMARY TO ZBFH_ZBFD_B OPEN PRESORT SECSORT  

COMMENT
Combining booking form and finish goods tables

OPEN VBAK_VBAP_VBKD_B PRIMARY
OPEN ZBFH_ZBFD_B SECONDARY
JOIN PKEY VBAP_VBELN VBAP_POSNR FIELDS SOLI VBAK_ERNAM VBAP_VBELN VBAP_POSNR VBAK_ERDAT VBAP_ABGRU VBAP_NETWR VBAP_KWMENG VBAP_WERKS VBAP_J_3ARQDA VBAP_ZZCUST_DEPT VBKD_KDGRP SKEY ZBFD_VBELN ZBFD_POSNR WITH ZBFINVH_STATUS ZBFH_ZBOOKFORM ZBFH_WERKS ZBFH_ZINV ZBFD_VBELN ZBFD_POSNR ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY PRIMARY TO VBAK_VBAP_VBKD_C OPEN PRESORT SECSORT

COMMENT
Adding sales order details

OPEN EKET_EKPO_EKKO
extract record if EKPO_LOEKZ <> "S" to EKET_EKPO_EKKO_A OPEN 
extract record if EKPO_LOEKZ <> "L" to EKET_EKPO_EKKO_B OPEN

COMMENT
Removing line item deletion and line item block

delete field digit_2 OK
define field digit_2 computed substr(EKET_J_3AUANR,1,1)

extract record if digit_2 = "5" OR digit_2 = "6" to EKET_EKPO_EKKO_C OPEN  

COMMENT
Filtering 3rd party orders from sales orders

delete field SO OK
define field SO computed substr(EKET_J_3AUANR,1,10)

extract record EKET_EBELN SO EKET_EBELP EKET_WEMNG EKET_J_3AUANR EKET_J_3ANETW EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS to EKET_EKPO_EKKO_D OPEN 
  
delete field SO_LI OK
define field SO_LI computed SO + EKET_J_3AUPOS  

extract record EKET_EBELN SO_LI EKET_EBELP EKET_WEMNG EKET_J_3AUANR EKET_J_3ANETW EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS to EKET_EKPO_EKKO_E OPEN 

summarize on EKET_EBELN SO_LI EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS subtotal EKET_WEMNG EKET_J_3ANETW to EKET_EKPO_EKKO_F OPEN PRESORT 

COMMENT
Removing duplicate line items 

summarize on SO_LI to EKET_EKPO_EKKO_G OPEN PRESORT  

extract record if COUNT > 1 to EKET_EKPO_EKKO_H OPEN 

COMMENT
Filtering sales order line items, if there is more than 1 record

OPEN EKET_EKPO_EKKO_F PRIMARY
OPEN EKET_EKPO_EKKO_H SECONDARY 
JOIN PKEY SO_LI FIELDS EKET_EBELN SO_LI EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS EKET_WEMNG EKET_J_3ANETW SKEY SO_LI WITH SO_LI PRIMARY TO EKET_EKPO_EKKO_I OPEN PRESORT SECSORT 

extract record if SO_LI2 = "" to EKET_EKPO_EKKO_J
extract record if SO_LI2 = "" to EKET_EKPO_EKKO_K 
extract record if SO_LI2 <> "" to EKET_EKPO_EKKO_L
extract record if SO_LI2 <> "" AND EKET_WEMNG > 0 to EKET_EKPO_EKKO_M OPEN   
extract FIELDS ALL TO EKET_EKPO_EKKO_K APPEND  

COMMET 
Filtering the Sales order lines with GRN
 
OPEN EKET_EKPO_EKKO_L PRIMARY
OPEN EKET_EKPO_EKKO_M SECONDARY
JOIN PKEY SO_LI FIELDS EKET_EBELN SO_LI EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS EKET_WEMNG EKET_J_3ANETW SKEY SO_LI WITH SO_LI PRIMARY TO EKET_EKPO_EKKO_N OPEN PRESORT SECSORT 
extract record if SO_LI2 = "" to EKET_EKPO_EKKO_O OPEN 

COMMENT
Considering orders without sales order line item
extract record EKET_EBELN SO_LI EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS EKET_WEMNG EKET_J_3ANETW TO EKET_EKPO_EKKO_P 

OPEN EKET_EKPO_EKKO_K 
extract record EKET_EBELN SO_LI EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS EKET_WEMNG EKET_J_3ANETW to EKET_EKPO_EKKO_Q 

OPEN EKET_EKPO_EKKO_P
extract FIELDS ALL TO EKET_EKPO_EKKO_Q APPEND 

OPEN EKET_EKPO_EKKO_Q

delete field USD_Value OK
define field USD_Value computed 

EKET_J_3ANETW*0.012 if EKKO_WAERS = "BDT" 
EKET_J_3ANETW*1.18 if EKKO_WAERS = "EUR"
EKET_J_3ANETW*1.31 if EKKO_WAERS = "GBP"
EKET_J_3ANETW*0.0071 if EKKO_WAERS = "IDR"
EKET_J_3ANETW*0.013 if EKKO_WAERS = "INR"
EKET_J_3ANETW*0.0054 if EKKO_WAERS = "LKR"
EKET_J_3ANETW*0.13 if EKKO_WAERS = "HKD"
EKET_J_3ANETW 

extract record EKET_EBELN SO_LI EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS EKET_WEMNG EKET_J_3ANETW USD_Value to EKET_EKPO_EKKO_R 

COMMENT 
Converting different currencies to USD

OPEN VBAK_VBAP_VBKD_C PRIMARY
OPEN EKET_EKPO_EKKO_R SECONDARY
JOIN PKEY SOLI FIELDS VBAK_ERNAM VBAP_VBELN VBAP_POSNR VBAK_ERDAT VBAP_ABGRU VBAP_NETWR VBAP_KWMENG VBAP_WERKS VBAP_J_3ARQDA VBAP_ZZCUST_DEPT VBKD_KDGRP ZBFH_ZBOOKFORM ZBFH_WERKS ZBFH_ZINV ZBFD_VBELN ZBFD_POSNR ZBFINVH_STATUS ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY SKEY SO_LI WITH EKET_EBELN SO_LI EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS EKET_WEMNG EKET_J_3ANETW USD_Value PRIMARY TO VBAK_VBAP_VBKD_D OPEN PRESORT SECSORT 

OPEN VBRP_VBRK

delete field digit_3 OK
define field digit_3 computed substr(VBRK_SFAKN,1,1)

COMMENT
Considering the billing data

delete field digit_4 OK
define field digit_4 computed substr(VBRP_VBELN,1,1)

COMMENT
Considering billing cancellations

extract record if VBRK_SFAKN <> "" AND digit_3 = "9" to VBRP_VBRK_A OPEN 
summarize on VBRK_SFAKN digit_3 to VBRP_VBRK_B OPEN PRESORT 

OPEN VBRP_VBRK

extract record if digit_4 = "9" to VBRP_VBRK_C OPEN  
summarize on VBRP_VBELN VBRP_AUBEL VBRP_AUPOS subtotal VBRP_FKIMG VBRP_NETWR to VBRP_VBRK_D OPEN PRESORT  

OPEN VBRP_VBRK_D PRIMARY 
OPEN VBRP_VBRK_B SECONDARY
JOIN PKEY VBRP_VBELN FIELDS VBRP_VBELN VBRP_AUBEL VBRP_AUPOS VBRP_FKIMG VBRP_NETWR SKEY VBRK_SFAKN WITH digit_3 PRIMARY TO VBRP_VBRK_E OPEN PRESORT SECSORT 

extract record if digit_3 = "" to VBRP_VBRK_F

OPEN VBAK_VBAP_VBKD_D PRIMARY
OPEN VBRP_VBRK_F SECONDARY
JOIN PKEY VBAP_VBELN VBAP_POSNR FIELDS VBAK_ERNAM VBAP_VBELN VBAP_POSNR VBAK_ERDAT VBAP_ABGRU VBAP_NETWR VBAP_KWMENG VBAP_WERKS VBAP_J_3ARQDA VBAP_ZZCUST_DEPT VBKD_KDGRP ZBFH_ZBOOKFORM ZBFH_WERKS ZBFH_ZINV ZBFD_VBELN ZBFD_POSNR ZBFINVH_STATUS ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY SO_LI EKET_EBELN EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS EKET_WEMNG EKET_J_3ANETW USD_Value SKEY VBRP_AUBEL VBRP_AUPOS WITH VBRP_VBELN VBRP_FKIMG VBRP_NETWR PRIMARY TO VBAK_VBAP_VBKD_E OPEN PRESORT SECSORT 

OPEN VBAK_VBAP_VBKD_E PRIMARY
OPEN LFA1_LFB1 SECONDARY
JOIN PKEY EKKO_LIFNR FIELDS VBAK_ERNAM VBAP_VBELN VBAP_POSNR VBAK_ERDAT VBAP_ABGRU VBAP_NETWR VBAP_KWMENG VBAP_WERKS VBAP_J_3ARQDA VBAP_ZZCUST_DEPT VBKD_KDGRP ZBFH_ZBOOKFORM ZBFH_WERKS ZBFH_ZINV ZBFD_VBELN ZBFINVH_STATUS ZBFD_POSNR ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY SO_LI EKET_EBELN EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS EKET_WEMNG EKET_J_3ANETW USD_Value VBRP_VBELN SKEY LFA1_LIFNR WITH LFA1_NAME1 PRIMARY TO VBAK_VBAP_VBKD_F OPEN PRESORT SECSORT

COMMENT
Adding supplier details

OPEN VBAK_VBAP_VBKD_F PRIMARY
OPEN T151T SECONDARY
JOIN PKEY VBKD_KDGRP FIELDS VBAK_ERNAM VBAP_VBELN VBAP_POSNR VBAK_ERDAT VBAP_ABGRU VBAP_NETWR VBAP_KWMENG VBAP_WERKS VBAP_J_3ARQDA VBAP_ZZCUST_DEPT VBKD_KDGRP ZBFH_ZBOOKFORM ZBFH_WERKS ZBFH_ZINV ZBFD_VBELN ZBFINVH_STATUS ZBFD_POSNR ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY SO_LI EKET_EBELN EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR LFA1_NAME1 EKKO_WAERS EKET_WEMNG EKET_J_3ANETW USD_Value VBRP_VBELN SKEY T151T_KDGRP WITH T151T_KTEXT PRIMARY TO VBAK_VBAP_VBKD_G OPEN PRESORT SECSORT

COMMENT
Adding customer groups

OPEN VBAK_VBAP_VBKD_G PRIMARY
OPEN ZCUST_DEPT_DATA SECONDARY
JOIN PKEY VBAP_ZZCUST_DEPT FIELDS VBAK_ERNAM VBAP_VBELN VBAP_POSNR VBAK_ERDAT VBAP_ABGRU VBAP_NETWR VBAP_KWMENG VBAP_WERKS VBAP_J_3ARQDA VBAP_ZZCUST_DEPT  VBKD_KDGRP T151T_KTEXT ZBFH_ZBOOKFORM ZBFINVH_STATUS ZBFH_WERKS ZBFH_ZINV ZBFD_VBELN ZBFD_POSNR ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY SO_LI EKET_EBELN EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR LFA1_NAME1 EKKO_WAERS EKET_WEMNG EKET_J_3ANETW USD_Value VBRP_VBELN SKEY ZCUST_DEPT_DATA_ZCUST_DEPT WITH ZCUST_DEPT_DATA_ZCUST_DEPT_DESC PRIMARY TO VBAK_VBAP_VBKD_H OPEN PRESORT SECSORT

summarize on VBAP_ZZCUST_DEPT VBAK_ERNAM VBAP_VBELN VBAP_POSNR VBAK_ERDAT VBAP_ABGRU VBAP_NETWR VBAP_KWMENG VBAP_WERKS VBAP_J_3ARQDA VBAP_ZZCUST_DEPT  VBKD_KDGRP T151T_KTEXT ZBFH_ZBOOKFORM ZBFINVH_STATUS ZBFH_WERKS ZBFH_ZINV ZBFD_VBELN ZBFD_POSNR ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY SO_LI EKET_EBELN EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR LFA1_NAME1 EKKO_WAERS EKET_WEMNG EKET_J_3ANETW USD_Value VBRP_VBELN ZCUST_DEPT_DATA_ZCUST_DEPT_DESC to VBAK_VBAP_VBKD_I OPEN PRESORT 

COMMENT
Removing duplicate line items

extract record if ZBFD_INV_CONF_QTY > 0 to VBAK_VBAP_VBKD_J OPEN   

COMMENT
Considering orders already invoiced

extract record if VBAP_VBELN <> "5000022823" to VBAK_VBAP_VBKD_JA OPEN
extract record if VBAP_VBELN <> "5000022831" to VBAK_VBAP_VBKD_JB OPEN
extract record if VBAP_VBELN <> "5000022833" to VBAK_VBAP_VBKD_JC OPEN
extract record if VBAP_VBELN <> "5000024062" to VBAK_VBAP_VBKD_JD OPEN

COMMENT
Removing some of the orders which want to ignore

DELETE FIELD C_Date OK
DEFINE FIELD C_Date COMPUTED Date(VBAP_J_3ARQDA)

DELETE FIELD C_Day OK
DEFINE FIELD C_Day COMPUTED SUBSTR(C_Date,4,2)

DELETE FIELD C_Month OK
DEFINE FIELD C_Month COMPUTED SUBSTR(C_Date,1,2)

DELETE FIELD C_Year OK
DEFINE FIELD C_Year COMPUTED SUBSTR(C_Date,7,4)

Delete field Key_1 OK
Define field Key_1 computed C_Year + C_Month +C_Day

Delete field Key_2 OK
Define field Key_2 computed Value(Key_1,0)
  
Extract record if Key_2 <= 20210507 to VBAK_VBAP_VBKD_KA OPEN 
Extract record if Key_2 >= 20200101 to VBAK_VBAP_VBKD_KB OPEN

COMMENT
Filtering order based on billing dates
