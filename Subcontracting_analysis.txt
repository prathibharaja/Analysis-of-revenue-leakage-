SET SAFETY OFF

SET PASSWORD 1 TO "Ela@123o"

IMPORT SAP PASSWORD 1 TO MKPF_MSEG_3 SAP SOURCE "SAP AGENT" <q version="6.0"><s>0</s><d>PDM                            </d><u>prathibhar  </u><c>300</c><lg>EN</lg><cf>MKPF_MSEG_3.fil</cf><sf>                                                                                                                                                                                                                                                               </sf><jcount>        </jcount><jname>                                </jname><dl>138 </dl><m>0</m><r>500</r><ar>1</ar><e>500</e><ts><t><n>MKPF</n><a>T00003</a><td>Header: Material Document</td><fs><f>MBLNR</f><f>MJAHR</f></fs><wc><w><f>CPUDT</f><o>6</o><l>20211001</l><h>20211016</h></w></wc></t><t><n>MSEG</n><a>T00004</a><td>Document Segment: Material</td><fs><f>MBLNR</f><f>MJAHR</f><f>BWART</f><f>MATNR</f><f>WERKS</f><f>CHARG</f><f>SHKZG</f><f>WAERS</f><f>DMBTR</f><f>MENGE</f><f>EBELN</f><f>MAT_KDAUF</f><f>MAT_KDPOS</f><f>CPUDT_MKPF</f></fs><wc><w><f>BUKRS</f><o>0</o><l>A000</l><h></h></w><w><f>BUKRS</f><o>0</o><l>A050</l><h></h></w><w><f>BUKRS</f><o>0</o><l>A100</l><h></h></w><w><f>BUKRS</f><o>0</o><l>A150</l><h></h></w><w><f>BUKRS</f><o>0</o><l>A250</l><h></h></w><w><f>BUKRS</f><o>0</o><l>A350</l><h></h></w></wc></t></ts><js><jc><pt><pa>T00003</pa><pf>MBLNR</pf></pt><ct><ca>T00004</ca><cf>MBLNR</cf></ct></jc><jc><pt><pa>T00003</pa><pf>MJAHR</pf></pt><ct><ca>T00004</ca><cf>MJAHR</cf></ct></jc></js></q>

COMMENT
Quary to dump MKPF_MSEG data

OPEN MKPF_MSEG_3

OPEN VBAK_VBAP_VBKD

delete field Digit_1 Ok
define field Digit_1 computed substr(VBAP_VBELN,1,1)

extract record if Digit_1 = "1" to VBAK_VBAP_VBKD_A OPEN

COMMNET
Considering normal orders

delete field SOLI OK
define field SOLI computed VBAP_VBELN + VBAP_POSNR

extract record SOLI VBAK_ERNAM VBAP_VBELN VBAP_POSNR VBAK_ERDAT VBAP_ABGRU VBAP_NETWR VBAP_KWMENG VBAP_WERKS VBAP_J_3ARQDA VBAP_ZZCUST_DEPT VBKD_KDGRP to VBAK_VBAP_VBKD_B 

OPEN ZBFH_ZBFD
extract record if ZBFH_LVORM <> "X" to ZBFH_ZBFD_A 

OPEN ZBFINVH 
extract record if ZBFINVH_STATUS <> "9" to ZBFINVH_A

COMMENT
Removing booking form deletion and invoice deletion

OPEN ZBFH_ZBFD_A PRIMARY 
OPEN ZBFINVH_A SECONDARY 
JOIN PKEY ZBFH_ZINV FIELDS ZBFH_ZBOOKFORM ZBFH_WERKS ZBFH_ZINV ZBFD_VBELN ZBFD_POSNR ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY SKEY ZBFINVH_ZINV WITH ZBFINVH_STATUS PRIMARY TO ZBFH_ZBFD_B OPEN PRESORT SECSORT  

COMMENT
Adding booking form and invoice details

OPEN VBAK_VBAP_VBKD_B PRIMARY
OPEN ZBFH_ZBFD_B SECONDARY
JOIN PKEY VBAP_VBELN VBAP_POSNR FIELDS SOLI VBAK_ERNAM VBAP_VBELN VBAP_POSNR VBAK_ERDAT VBAP_ABGRU VBAP_NETWR VBAP_KWMENG VBAP_WERKS VBAP_J_3ARQDA VBAP_ZZCUST_DEPT VBKD_KDGRP SKEY ZBFD_VBELN ZBFD_POSNR WITH ZBFINVH_STATUS ZBFH_ZBOOKFORM ZBFH_WERKS ZBFH_ZINV ZBFD_VBELN ZBFD_POSNR ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY PRIMARY TO VBAK_VBAP_VBKD_C OPEN PRESORT SECSORT

COMMENT
Adding sales order details

OPEN EKET_EKPO_EKKO
extract record if EKPO_LOEKZ <> "S" to EKET_EKPO_EKKO_A OPEN
extract record if EKPO_LOEKZ <> "L" to EKET_EKPO_EKKO_B OPEN

COMMENT
Removing PO line item deletion and 

delete field digit_2 OK
define field digit_2 computed substr(EKET_J_3AUANR,1,1)

extract record if EKPO_MTART = "FERT" to EKET_EKPO_EKKO_C OPEN  
extract record if EKPO_PSTYP = "3" to EKET_EKPO_EKKO_D OPEN 

COMMENT
Filtering subcontracting orders

delete field SO OK
define field SO computed substr(EKET_J_3AUANR,1,10)

extract record EKET_EBELN EKPO_MATNR EKPO_TXZ01 SO EKET_EBELP EKET_WEMNG EKET_J_3AUANR EKET_J_3ANETW EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS to EKET_EKPO_EKKO_E OPEN 
  
delete field SO_LI OK
define field SO_LI computed SO + EKET_J_3AUPOS  

extract record EKET_EBELN EKPO_MATNR EKPO_TXZ01 SO_LI EKET_EBELP EKET_WEMNG EKET_J_3AUANR EKET_J_3ANETW EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS to EKET_EKPO_EKKO_F OPEN 

summarize on EKET_EBELN EKPO_MATNR EKPO_TXZ01 SO_LI EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS subtotal EKET_WEMNG EKET_J_3ANETW to EKET_EKPO_EKKO_G OPEN PRESORT 

summarize on SO_LI to EKET_EKPO_EKKO_H OPEN PRESORT  

extract record if COUNT > 1 to EKET_EKPO_EKKO_I OPEN 

OPEN EKET_EKPO_EKKO_G PRIMARY
OPEN EKET_EKPO_EKKO_I SECONDARY 
JOIN PKEY SO_LI FIELDS EKET_EBELN EKPO_MATNR EKPO_TXZ01 SO_LI EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS EKET_WEMNG EKET_J_3ANETW SKEY SO_LI WITH SO_LI PRIMARY TO EKET_EKPO_EKKO_J OPEN PRESORT SECSORT 

extract record if SO_LI2 = "" to EKET_EKPO_EKKO_K 
extract record if SO_LI2 = "" to EKET_EKPO_EKKO_L
extract record if SO_LI2 <> "" to EKET_EKPO_EKKO_M
extract record if SO_LI2 <> "" AND EKET_WEMNG > 0 to EKET_EKPO_EKKO_N OPEN   
extract FIELDS ALL TO EKET_EKPO_EKKO_L APPEND  

COMMENT
Considering GRN exist Sales order line items
 
OPEN EKET_EKPO_EKKO_M PRIMARY
OPEN EKET_EKPO_EKKO_N SECONDARY
JOIN PKEY SO_LI FIELDS EKET_EBELN EKPO_MATNR EKPO_TXZ01 SO_LI EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS EKET_WEMNG EKET_J_3ANETW SKEY SO_LI WITH SO_LI PRIMARY TO EKET_EKPO_EKKO_O OPEN PRESORT SECSORT 

extract record if SO_LI2 = "" to EKET_EKPO_EKKO_P OPEN 
extract record EKET_EBELN EKPO_MATNR EKPO_TXZ01 SO_LI EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS EKET_WEMNG EKET_J_3ANETW TO EKET_EKPO_EKKO_Q 

OPEN EKET_EKPO_EKKO_L 
extract record EKET_EBELN EKPO_MATNR EKPO_TXZ01 SO_LI EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS EKET_WEMNG EKET_J_3ANETW to EKET_EKPO_EKKO_R

OPEN EKET_EKPO_EKKO_Q
extract FIELDS ALL TO EKET_EKPO_EKKO_R APPEND 

OPEN EKET_EKPO_EKKO_R

delete field USD_Value OK
define field USD_Value computed 

EKET_J_3ANETW*0.012 if EKKO_WAERS = "BDT" 
EKET_J_3ANETW*1.18 if EKKO_WAERS = "EUR"
EKET_J_3ANETW*1.31 if EKKO_WAERS = "GBP"
EKET_J_3ANETW*0.0071 if EKKO_WAERS = "IDR"
EKET_J_3ANETW*0.013 if EKKO_WAERS = "INR"
EKET_J_3ANETW*0.0054 if EKKO_WAERS = "LKR"
EKET_J_3ANETW*0.13 if EKKO_WAERS = "HKD"
EKET_J_3ANETW 

extract record EKET_EBELN EKPO_MATNR EKPO_TXZ01 SO_LI EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS EKET_WEMNG EKET_J_3ANETW USD_Value to EKET_EKPO_EKKO_S

COMMENT
Changing currency to USD

OPEN EKET_EKPO_EKKO_S PRIMARY
OPEN VBAK_VBAP_VBKD_C SECONDARY
JOIN PKEY SO_LI FIELDS EKET_EBELN EKPO_MATNR EKPO_TXZ01 SO_LI EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS EKET_WEMNG EKET_J_3ANETW USD_Value SKEY SOLI WITH VBAK_ERNAM VBAP_VBELN VBAP_POSNR VBAK_ERDAT VBAP_ABGRU VBAP_NETWR VBAP_KWMENG VBAP_WERKS VBAP_J_3ARQDA VBAP_ZZCUST_DEPT VBKD_KDGRP ZBFH_ZBOOKFORM ZBFH_WERKS ZBFH_ZINV ZBFD_VBELN ZBFD_POSNR ZBFINVH_STATUS ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY PRIMARY TO VBAK_VBAP_VBKD_D OPEN PRESORT SECSORT 

OPEN VBRP_VBRK

delete field digit_3 OK
define field digit_3 computed substr(VBRK_SFAKN,1,1)

delete field digit_4 OK
define field digit_4 computed substr(VBRP_VBELN,1,1)

extract record if VBRK_SFAKN <> "" AND digit_3 = "9" to VBRP_VBRK_A OPEN 
summarize on VBRK_SFAKN digit_3 to VBRP_VBRK_B OPEN PRESORT 

OPEN VBRP_VBRK

extract record if digit_4 = "9" to VBRP_VBRK_C OPEN  
summarize on VBRP_VBELN VBRP_AUBEL VBRP_AUPOS subtotal VBRP_FKIMG VBRP_NETWR to VBRP_VBRK_D OPEN PRESORT  

COMMENT
Removing booking form deletion

OPEN VBRP_VBRK_D PRIMARY 
OPEN VBRP_VBRK_B SECONDARY
JOIN PKEY VBRP_VBELN FIELDS VBRP_VBELN VBRP_AUBEL VBRP_AUPOS VBRP_FKIMG VBRP_NETWR SKEY VBRK_SFAKN WITH digit_3 PRIMARY TO VBRP_VBRK_E OPEN PRESORT SECSORT 

extract record if digit_3 = "" to VBRP_VBRK_F

OPEN VBAK_VBAP_VBKD_D PRIMARY
OPEN VBRP_VBRK_F SECONDARY
JOIN PKEY VBAP_VBELN VBAP_POSNR FIELDS VBAK_ERNAM VBAP_VBELN VBAP_POSNR VBAK_ERDAT VBAP_ABGRU VBAP_NETWR VBAP_KWMENG VBAP_WERKS VBAP_J_3ARQDA VBAP_ZZCUST_DEPT VBKD_KDGRP ZBFH_ZBOOKFORM ZBFH_WERKS ZBFH_ZINV ZBFD_VBELN ZBFD_POSNR ZBFINVH_STATUS ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY SO_LI EKET_EBELN EKPO_MATNR EKPO_TXZ01 EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS EKET_WEMNG EKET_J_3ANETW USD_Value SKEY VBRP_AUBEL VBRP_AUPOS WITH VBRP_VBELN VBRP_FKIMG VBRP_NETWR PRIMARY TO VBAK_VBAP_VBKD_E OPEN PRESORT SECSORT 

OPEN VBAK_VBAP_VBKD_E PRIMARY
OPEN LFA1_LFB1 SECONDARY
JOIN PKEY EKKO_LIFNR FIELDS VBAK_ERNAM VBAP_VBELN VBAP_POSNR VBAK_ERDAT VBAP_ABGRU VBAP_NETWR VBAP_KWMENG VBAP_WERKS VBAP_J_3ARQDA VBAP_ZZCUST_DEPT VBKD_KDGRP ZBFH_ZBOOKFORM EKPO_MATNR EKPO_TXZ01 ZBFH_WERKS ZBFH_ZINV ZBFD_VBELN ZBFINVH_STATUS ZBFD_POSNR ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY SO_LI EKET_EBELN EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR EKKO_WAERS EKET_WEMNG EKET_J_3ANETW USD_Value VBRP_VBELN SKEY LFA1_LIFNR WITH LFA1_NAME1 PRIMARY TO VBAK_VBAP_VBKD_F OPEN PRESORT SECSORT

COMMENT
Adding supplier details

OPEN VBAK_VBAP_VBKD_F PRIMARY
OPEN T151T SECONDARY
JOIN PKEY VBKD_KDGRP FIELDS VBAK_ERNAM VBAP_VBELN VBAP_POSNR VBAK_ERDAT VBAP_ABGRU VBAP_NETWR VBAP_KWMENG VBAP_WERKS VBAP_J_3ARQDA VBAP_ZZCUST_DEPT VBKD_KDGRP ZBFH_ZBOOKFORM ZBFH_WERKS EKPO_MATNR EKPO_TXZ01 ZBFH_ZINV ZBFD_VBELN ZBFINVH_STATUS ZBFD_POSNR ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY SO_LI EKET_EBELN EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR LFA1_NAME1 EKKO_WAERS EKET_WEMNG EKET_J_3ANETW USD_Value VBRP_VBELN SKEY T151T_KDGRP WITH T151T_KTEXT PRIMARY TO VBAK_VBAP_VBKD_G OPEN PRESORT SECSORT

COMMENT
Adding customer groups

OPEN VBAK_VBAP_VBKD_G PRIMARY
OPEN ZCUST_DEPT_DATA SECONDARY
JOIN PKEY VBAP_ZZCUST_DEPT FIELDS VBAK_ERNAM EKPO_MATNR EKPO_TXZ01 VBAP_VBELN VBAP_POSNR VBAK_ERDAT VBAP_ABGRU VBAP_NETWR VBAP_KWMENG VBAP_WERKS VBAP_J_3ARQDA VBAP_ZZCUST_DEPT VBKD_KDGRP T151T_KTEXT ZBFH_ZBOOKFORM ZBFINVH_STATUS ZBFH_WERKS ZBFH_ZINV ZBFD_VBELN ZBFD_POSNR ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY SO_LI EKET_EBELN EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR LFA1_NAME1 EKKO_WAERS EKET_WEMNG EKET_J_3ANETW USD_Value VBRP_VBELN SKEY ZCUST_DEPT_DATA_ZCUST_DEPT WITH ZCUST_DEPT_DATA_ZCUST_DEPT_DESC PRIMARY TO VBAK_VBAP_VBKD_H OPEN PRESORT SECSORT

COMMENT
Adding customer names

OPEN LIPS_LIKP 

delete field digit_1 OK 
define field digit_1 computed substr(LIPS_POSNR,1,1) 

extract record if digit_1 = "9" to LIPS_LIKP_A OPEN    

summarize on LIPS_VGBEL LIPS_VGPOS LIPS_VBELN LIKP_WADAT_IST subtotal LIPS_LFIMG to LIPS_LIKP_B OPEN PRESORT 
Extract record if LIPS_LFIMG > 0 to LIPS_LIKP_C OPEN

delete field C_Date OK
define field C_Date computed Date(LIKP_WADAT_IST)

extract record if C_Date <> "" to LIPS_LIKP_D  

OPEN VBAK_VBAP_VBKD_H PRIMARY 
OPEN LIPS_LIKP_D SECONDARY 
JOIN PKEY VBAP_VBELN VBAP_POSNR FIELDS VBAK_ERNAM EKPO_MATNR EKPO_TXZ01 VBAP_VBELN VBAP_POSNR VBAK_ERDAT VBAP_ABGRU VBAP_NETWR VBAP_KWMENG VBAP_WERKS VBAP_J_3ARQDA VBAP_ZZCUST_DEPT VBKD_KDGRP T151T_KTEXT ZBFH_ZBOOKFORM ZBFINVH_STATUS ZBFH_WERKS ZBFH_ZINV ZBFD_VBELN ZBFD_POSNR ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY SO_LI EKET_EBELN EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR LFA1_NAME1 EKKO_WAERS EKET_WEMNG EKET_J_3ANETW USD_Value VBRP_VBELN ZCUST_DEPT_DATA_ZCUST_DEPT_DESC SKEY LIPS_VGBEL LIPS_VGPOS WITH LIPS_VBELN PRIMARY TO VBAK_VBAP_VBKD_I OPEN PRESORT SECSORT

COMMENT
Adding delivery details

summarize on LIPS_VBELN EKPO_MATNR EKPO_TXZ01 VBAP_ZZCUST_DEPT VBAK_ERNAM VBAP_VBELN VBAP_POSNR VBAK_ERDAT VBAP_ABGRU VBAP_NETWR VBAP_KWMENG VBAP_WERKS VBAP_J_3ARQDA VBAP_ZZCUST_DEPT  VBKD_KDGRP T151T_KTEXT ZBFH_ZBOOKFORM ZBFINVH_STATUS ZBFH_WERKS ZBFH_ZINV ZBFD_VBELN ZBFD_POSNR ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY SO_LI EKET_EBELN EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR LFA1_NAME1 EKKO_WAERS EKET_WEMNG EKET_J_3ANETW USD_Value VBRP_VBELN ZCUST_DEPT_DATA_ZCUST_DEPT_DESC to VBAK_VBAP_VBKD_J OPEN PRESORT 

OPEN MKPF_MSEG_2

extract fields MKPF_MBLNR MKPF_MJAHR MSEG_MBLNR MSEG_MJAHR MSEG_BWART MSEG_MATNR MSEG_WERKS MSEG_CHARG MSEG_SHKZG MSEG_WAERS MSEG_DMBTR MSEG_MENGE MSEG_EBELN MSEG_MAT_KDAUF MSEG_MAT_KDPOS MSEG_CPUDT_MKPF to MKPF_MSEG_1  

OPEN MKPF_MSEG_3
extract fields all to MKPF_MSEG_1 APPEND 

OPEN AFPO

summarize on AFPO_KDAUF AFPO_KDPOS subtotal AFPO_WEMNG to AFPO_A OPEN PRESORT   

OPEN VBAK_VBAP_VBKD_J PRIMARY
OPEN AFPO_A SECONDARY 
JOIN PKEY VBAP_VBELN VBAP_POSNR FIELDS LIPS_VBELN EKPO_MATNR EKPO_TXZ01 VBAP_ZZCUST_DEPT VBAK_ERNAM VBAP_VBELN VBAP_POSNR VBAK_ERDAT VBAP_ABGRU VBAP_NETWR VBAP_KWMENG VBAP_WERKS VBAP_J_3ARQDA VBAP_ZZCUST_DEPT  VBKD_KDGRP T151T_KTEXT ZBFH_ZBOOKFORM ZBFINVH_STATUS ZBFH_WERKS ZBFH_ZINV ZBFD_VBELN ZBFD_POSNR ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY SO_LI EKET_EBELN EKET_EBELP EKET_J_3AUANR EKET_J_3AUPOS EKPO_MENGE EKKO_LIFNR LFA1_NAME1 EKKO_WAERS EKET_WEMNG EKET_J_3ANETW USD_Value VBRP_VBELN ZCUST_DEPT_DATA_ZCUST_DEPT_DESC SKEY AFPO_KDAUF AFPO_KDPOS WITH AFPO_KDAUF AFPO_KDPOS AFPO_WEMNG PRIMARY TO VBAK_VBAP_VBKD_K OPEN PRESORT SECSORT

extract record if AFPO_WEMNG <= 0 to VBAK_VBAP_VBKD_JA OPEN 

COMMENT
Considering orders with no delivery 

delete field GRN_Qty OK
define field GRN_Qty computed EKET_WEMNG  

extract record LIPS_VBELN GRN_Qty VBRP_VBELN EKPO_MATNR EKPO_TXZ01 ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY ZBFD_VBELN ZBFD_POSNR ZBFH_ZBOOKFORM ZBFH_ZINV ZBFH_WERKS T151T_KTEXT ZCUST_DEPT_DATA_ZCUST_DEPT_DESC ZBFINVH_STATUS EKKO_WAERS EKKO_LIFNR EKPO_MENGE VBKD_KDGRP VBAK_ERDAT VBAK_ERNAM VBAP_KWMENG VBAP_ZZCUST_DEPT VBAP_NETWR VBAP_WERKS VBAP_ABGRU VBAP_J_3ARQDA VBAP_VBELN VBAP_POSNR EKET_EBELP EKET_J_3ANETW EKET_EBELN EKET_WEMNG EKET_J_3AUANR EKET_J_3AUPOS SO_LI USD_Value LFA1_NAME1 to VBAK_VBAP_VBKD_L OPEN 

delete field Key_3 OK
define field Key_3 computed EKPO_MATNR + VBAP_VBELN + VBAP_POSNR 

extract record Key_3 LIPS_VBELN GRN_Qty VBRP_VBELN EKPO_MATNR EKPO_TXZ01 ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY ZBFD_VBELN ZBFD_POSNR ZBFH_ZBOOKFORM ZBFH_ZINV ZBFH_WERKS T151T_KTEXT ZCUST_DEPT_DATA_ZCUST_DEPT_DESC ZBFINVH_STATUS EKKO_WAERS EKKO_LIFNR EKPO_MENGE VBKD_KDGRP VBAK_ERDAT VBAK_ERNAM VBAP_KWMENG VBAP_ZZCUST_DEPT VBAP_NETWR VBAP_WERKS VBAP_ABGRU VBAP_J_3ARQDA VBAP_VBELN VBAP_POSNR EKET_EBELP EKET_J_3ANETW EKET_EBELN EKET_WEMNG EKET_J_3AUANR EKET_J_3AUPOS SO_LI USD_Value LFA1_NAME1 to VBAK_VBAP_VBKD_KA OPEN 
  
OPEN MKPF_MSEG_1
delete field digit_1 OK
define field digit_1 computed substr(MSEG_MATNR,9,1)

extract record if digit_1 = "7" to MKPF_MSEG_A OPEN 
 
delete field digit_2 OK
define field digit_2 computed substr(MSEG_MATNR,1,1)

extract record if digit_2 = "0" to MKPF_MSEG_AA OPEN 
extract record if MSEG_MAT_KDAUF <> "" to MKPF_MSEG_AB OPEN 

delete field Key_1 OK
define field Key_1 computed MSEG_MATNR + MSEG_MAT_KDAUF + MSEG_MAT_KDPOS

summarize on Key_1 MSEG_BWART MSEG_SHKZG MSEG_MATNR MSEG_MAT_KDAUF MSEG_MAT_KDPOS subtotal MSEG_MENGE to MKPF_MSEG_AC OPEN PRESORT  
summarize on Key_1 MSEG_BWART MSEG_MATNR MSEG_MAT_KDAUF MSEG_MAT_KDPOS subtotal MSEG_MENGE to MKPF_MSEG_AD OPEN PRESORT  

OPEN MKPF_MSEG_AC 

delete field FG_Qty OK
define field FG_Qty computed 

-MSEG_MENGE if MSEG_SHKZG = "H"  
MSEG_MENGE if MSEG_SHKZG = "S" 
0

extract record FG_Qty Key_1 MSEG_MATNR MSEG_MAT_KDAUF MSEG_MAT_KDPOS to MKPF_MSEG_B OPEN 
summarize on Key_1 MSEG_MATNR MSEG_MAT_KDAUF MSEG_MAT_KDPOS subtotal FG_Qty to MKPF_MSEG_BA OPEN PRESORT  


OPEN MKPF_MSEG_AD

extract record if MSEG_BWART = "Z09" to MKPF_MSEG_C OPEN

delete field Transfer_Qty OK
define field Transfer_Qty computed -MSEG_MENGE

extract record Transfer_Qty Key_1 MSEG_MATNR MSEG_MAT_KDAUF MSEG_MAT_KDPOS to MKPF_MSEG_CA OPEN
extract fields all to MKPF_MSEG_BB
OPEN MKPF_MSEG_BB
extract record Transfer_Qty Key_1 MSEG_MATNR MSEG_MAT_KDAUF MSEG_MAT_KDPOS to MKPF_MSEG_BC OPEN
   
OPEN MKPF_MSEG_AC

extract record if MSEG_BWART = "413" OR MSEG_BWART = "414" OR MSEG_BWART = "309" OR MSEG_BWART = "311" OR MSEG_BWART = "315" OR MSEG_BWART = "351" OR MSEG_BWART = "352" to MKPF_MSEG_D OPEN 
 
delete field Transfer_Qty OK
define field Transfer_Qty computed 

-MSEG_MENGE if MSEG_SHKZG = "H"  
MSEG_MENGE if MSEG_SHKZG = "S" 
0

summarize on Key_1 MSEG_MATNR MSEG_MAT_KDAUF MSEG_MAT_KDPOS subtotal Transfer_Qty to MKPF_MSEG_DA OPEN presort  
extract record Transfer_Qty Key_1 MSEG_MATNR MSEG_MAT_KDAUF MSEG_MAT_KDPOS to MKPF_MSEG_DB OPEN

extract fields all to MKPF_MSEG_BC APPEND

OPEN MKPF_MSEG_BC
summarize on Key_1 MSEG_MATNR MSEG_MAT_KDAUF MSEG_MAT_KDPOS subtotal Transfer_Qty to MKPF_MSEG_BD OPEN presort 

OPEN MKPF_MSEG_BA PRIMARY 
OPEN MKPF_MSEG_BD SECONDARY
JOIN PKEY Key_1 FIELDS Key_1 MSEG_MATNR MSEG_MAT_KDAUF MSEG_MAT_KDPOS FG_Qty SKEY Key_1 WITH Transfer_Qty PRIMARY TO MKPF_MSEG_E OPEN PRESORT SECSORT 

COMMENT
Considering credit and debit deliveries

OPEN VBAK_VBAP_VBKD_KA PRIMARY 
OPEN MKPF_MSEG_E SECONDARY
JOIN PKEY Key_3 FIELDS LIPS_VBELN Key_3 GRN_Qty VBRP_VBELN EKPO_MATNR EKPO_TXZ01 ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY ZBFD_VBELN ZBFD_POSNR ZBFH_ZBOOKFORM ZBFH_ZINV ZBFH_WERKS T151T_KTEXT ZCUST_DEPT_DATA_ZCUST_DEPT_DESC ZBFINVH_STATUS EKKO_WAERS EKKO_LIFNR EKPO_MENGE VBKD_KDGRP VBAK_ERDAT VBAK_ERNAM VBAP_KWMENG VBAP_ZZCUST_DEPT VBAP_NETWR VBAP_WERKS VBAP_ABGRU VBAP_J_3ARQDA VBAP_VBELN VBAP_POSNR EKET_EBELP EKET_J_3ANETW EKET_EBELN EKET_WEMNG EKET_J_3AUANR EKET_J_3AUPOS SO_LI USD_Value LFA1_NAME1 SKEY Key_1 WITH Key_1 MSEG_MATNR MSEG_MAT_KDAUF MSEG_MAT_KDPOS Transfer_Qty FG_Qty PRIMARY TO VBAK_VBAP_VBKD_KB OPEN PRESORT SECSORT 

Comment
Adding sales order details

extract record LIPS_VBELN Transfer_Qty FG_Qty GRN_Qty VBRP_VBELN EKPO_MATNR EKPO_TXZ01 ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY ZBFD_VBELN ZBFD_POSNR ZBFH_ZBOOKFORM ZBFH_ZINV ZBFH_WERKS T151T_KTEXT ZCUST_DEPT_DATA_ZCUST_DEPT_DESC ZBFINVH_STATUS EKKO_WAERS EKKO_LIFNR EKPO_MENGE VBKD_KDGRP VBAK_ERDAT VBAK_ERNAM VBAP_KWMENG VBAP_ZZCUST_DEPT VBAP_NETWR VBAP_WERKS VBAP_ABGRU VBAP_J_3ARQDA VBAP_VBELN VBAP_POSNR EKET_EBELP EKET_J_3ANETW EKET_EBELN EKET_WEMNG EKET_J_3AUANR EKET_J_3AUPOS SO_LI USD_Value LFA1_NAME1 to VBAK_VBAP_VBKD_KC OPEN

DELETE FIELD C_Date OK
DEFINE FIELD C_Date COMPUTED Date(VBAP_J_3ARQDA)

DELETE FIELD C_Day OK
DEFINE FIELD C_Day COMPUTED SUBSTR(C_Date,4,2)

DELETE FIELD C_Month OK
DEFINE FIELD C_Month COMPUTED SUBSTR(C_Date,1,2)

DELETE FIELD C_Year OK
DEFINE FIELD C_Year COMPUTED SUBSTR(C_Date,7,4)

Delete field Key_1 OK
Define field Key_1 computed C_Year + C_Month +C_Day

Delete field Key_2 OK
Define field Key_2 computed Value(Key_1,0)
  
Extract record if Key_2 <= 20211001 to VBAK_VBAP_VBKD_RA OPEN 
Extract record if Key_2 >= 20200101 to VBAK_VBAP_VBKD_RB OPEN

extract record if VBAP_WERKS <> "A061" to VBAK_VBAP_VBKD_RC OPEN 

delete field SO_LI OK
define field SO_LI computed VBAP_VBELN + VBAP_POSNR

extract record if SO_LI <> "1000330640000010" to VBAK_VBAP_VBKD_RD OPEN 
extract record if SO_LI <> "1000336352000010" to VBAK_VBAP_VBKD_RE OPEN 
extract record if SO_LI <> "1000336358000010" to VBAK_VBAP_VBKD_RF OPEN 
extract record if SO_LI <> "1000336369000010" to VBAK_VBAP_VBKD_RG OPEN 
extract record if SO_LI <> "1000336373000010" to VBAK_VBAP_VBKD_RH OPEN 
extract record if SO_LI <> "1000344840000010" to VBAK_VBAP_VBKD_RI OPEN 
extract record if SO_LI <> "1000367172000010" to VBAK_VBAP_VBKD_RJ OPEN 
extract record if SO_LI <> "1000349801000010" to VBAK_VBAP_VBKD_RK OPEN 
extract record if SO_LI <> "1000349801000020" to VBAK_VBAP_VBKD_RL OPEN 
extract record if SO_LI <> "1000326700000070" to VBAK_VBAP_VBKD_RM OPEN 
extract record if SO_LI <> "1000326700000080" to VBAK_VBAP_VBKD_RN OPEN 
extract record if SO_LI <> "1000310961000010" to VBAK_VBAP_VBKD_RO OPEN 
extract record if SO_LI <> "1000310962000010" to VBAK_VBAP_VBKD_RP OPEN 
extract record if SO_LI <> "1000256756000010" to VBAK_VBAP_VBKD_RQ OPEN 
extract record if SO_LI <> "1000256758000010" to VBAK_VBAP_VBKD_RR OPEN 
extract record if SO_LI <> "1000256758000010" to VBAK_VBAP_VBKD_RS OPEN 
extract record if SO_LI <> "1000256758000020" to VBAK_VBAP_VBKD_RT OPEN 

Comment
Removing some of the orders 

EXPORT FIELDS LIPS_VBELN Transfer_Qty FG_Qty GRN_Qty VBRP_VBELN EKPO_MATNR EKPO_TXZ01 ZBFD_KWMENG ZBFD_ORD_TOL ZBFD_INV_CONF_QTY ZBFD_BOOKED_QTY ZBFD_VBELN ZBFD_POSNR ZBFH_ZBOOKFORM ZBFH_ZINV ZBFH_WERKS T151T_KTEXT ZCUST_DEPT_DATA_ZCUST_DEPT_DESC ZBFINVH_STATUS EKKO_WAERS EKKO_LIFNR EKPO_MENGE VBKD_KDGRP VBAK_ERDAT VBAK_ERNAM VBAP_KWMENG VBAP_ZZCUST_DEPT VBAP_NETWR VBAP_WERKS VBAP_ABGRU VBAP_J_3ARQDA VBAP_VBELN VBAP_POSNR EKET_EBELP EKET_J_3ANETW EKET_EBELN EKET_WEMNG EKET_J_3AUANR EKET_J_3AUPOS SO_LI USD_Value LFA1_NAME1 DELIMITED TO "Subcontracting SO Analysis" KEEPTITLE SEPARATOR "|" QUALIFIER NONE 

Comment
Filtering the needed columns 
